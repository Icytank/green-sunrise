---
import { getImage } from "astro:assets";
import type { GetImageResult } from "astro";
import { BUSINESS, OG, SITE } from "@data/client";
import { getLocalBusinessSchema } from "@utils/localBusinessSchema.js";

// Props and Types
type HeroImage = GetImageResult | ImageMetadata;

interface Props {
	title?: string; // Override default title
	description?: string; // Override default description
	heroImage?: HeroImage | ImageMetadata; // Can be optimized hero OR raw ImageMetadata
    lang?: string;
    ogType?: string;
    alternateLinks?: { lang: string; href: string }[];
}

const { 
    title = SITE.title, 
    description = SITE.description, 
    heroImage, 
    lang = "bg",
    ogType = "website",
    alternateLinks = []
} = Astro.props;

// Data
const localBusinessSchema = getLocalBusinessSchema(Astro.url.origin);
const canonical = Astro.url.href;

// Detect home page for special title formatting
const isHomePage = Astro.url.pathname === `/${lang}` || Astro.url.pathname === `/${lang}/`;

// Format page title with business name (and location if home page)
// Note: Pages often pass the full title now, so we avoid double branding if the passed title handles it.
// But to maintain consistency with the existing logic:
const pageTitle = isHomePage ? `${title} | ${BUSINESS.name} | ${BUSINESS.address.city}, ${BUSINESS.address.state}` : `${title} | ${BUSINESS.name}`;

// Use page-specific values for OG tags
const ogTitle = pageTitle;
const ogDescription = description;

// Social image logic - Priority: 1) Provided heroImage, 2) Default /assets/social.jpg
let socialImage: string;
let socialImageType = "image/jpeg"; // Default

if (heroImage) {
	// Check if it's already optimized (has .src property) or needs optimization
	if ("src" in heroImage && typeof heroImage.src === "string") {
		// Already optimized by page (GetImageResult or ContentImage)
		socialImage = Astro.url.origin + heroImage.src;
        // Try to guess type from extension if possible, or default to whatever it is (browsers handle mismatched type often, but bots prefer correctness)
        if (heroImage.src.endsWith('.webp')) socialImageType = "image/webp";
        else if (heroImage.src.endsWith('.png')) socialImageType = "image/png";
	} else {
		// Raw ImageMetadata - optimize it for OG
		const optimizedImage = await getImage({
			src: heroImage as ImageMetadata,
			width: 1200,
			height: 600,
			format: "webp",
		});
		socialImage = Astro.url.origin + optimizedImage.src;
        socialImageType = "image/webp";
	}
} else {
	// Default social image (static file in public/)
	socialImage = Astro.url.origin + OG.image;
    // Assuming default is jpg as per original code
}
---

<!-- LocalBusiness Schema (on ALL pages) - customize your JSON-LD structured data:
     https://developers.google.com/search/docs/advanced/structured-data/intro-structured-data  -->
<script is:inline type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} />

<!-- Allow additional schemas from child layouts (e.g., BlogPosting for blog posts) -->
<slot name="schema" />

<!-- Page Title -->
<title>{pageTitle}</title>

<!-- Standard Meta Tags -->
<meta charset="utf-8" />
<meta name="description" content={description} />
<meta name="web_author" content={SITE.author} />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<link rel="canonical" href={canonical} />

<!-- Hreflang Tags -->
{alternateLinks.map(link => (
    <link rel="alternate" hreflang={link.lang} href={link.href} />
))}

<!-- Open Graph / Facebook -->
<meta property="og:locale" content={lang === 'bg' ? 'bg_BG' : 'en_US'} />
<meta property="og:url" content={canonical} />
<meta property="og:type" content={ogType} />
<meta property="og:title" content={ogTitle} />
<meta property="og:site_name" content={SITE.title} />
<meta property="og:description" content={ogDescription} />
<meta property="og:image" content={socialImage} />
<meta content="1200" property="og:image:width" />
<meta content="600" property="og:image:height" />
<meta content={socialImageType} property="og:image:type" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain" content={SITE.url.replace("https://", "")} />
<meta property="twitter:url" content={canonical} />
<meta name="twitter:title" content={ogTitle} />
<meta name="twitter:description" content={ogDescription} />
<meta name="twitter:image" content={socialImage} />

<!-- Favicons -->
<!-- Use [RealFaviconGenerator.net](https://realfavicongenerator.net/) -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png?v1" />
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" />
<link rel="manifest" href="/assets/favicons/site.webmanifest" />
<meta name="msapplication-TileColor" content="#064E3B" />
<meta name="theme-color" content="#064E3B" />
