---
// Utils
import { ClientRouter } from "astro:transitions";
import type { GetImageResult } from "astro";
import "@styles/tokens.css";
import "@styles/global.css";

// Components
import DynamicHeader from "@components/Header/DynamicHeader.astro";
import Footer from "@components/Footer/Footer.astro";
import Meta from "@components/Meta/Meta.astro";

// Data
import { SITE } from "@data/client";

// Create a union type for heroImage
type HeroImage = GetImageResult | ImageMetadata;

interface Props {
	title: string;
	description: string;
	lang?: string;
	heroImage?: HeroImage; // optional - passing a heroImage to BaseLayout will 1. preload the image and 2. use the image for og socials tags in the <head>
    ogType?: string;
    alternateLinks?: { lang: string; href: string }[];
}

const { description, title, heroImage, lang = "bg", ogType, alternateLinks } = Astro.props as Props;

// Smart default for alternate links if not provided (assumes symmetric URL structure)
let finalAlternateLinks = alternateLinks;
if (!finalAlternateLinks) {
    const currentPath = Astro.url.pathname;
    // Remove trailing slash for consistency check, but preserve for replacement if needed, 
    // although Astro usually normalizes.
    
    // Check if path starts with /bg or /en
    if (lang === 'bg' && currentPath.startsWith('/bg')) {
        finalAlternateLinks = [{ lang: 'en', href: Astro.url.origin + currentPath.replace('/bg', '/en') }];
    } else if (lang === 'en' && currentPath.startsWith('/en')) {
         finalAlternateLinks = [{ lang: 'bg', href: Astro.url.origin + currentPath.replace('/en', '/bg') }];
    }
}
---

<html lang={lang}>
	<head>
		<!-- View Transitions support -->
		<ClientRouter />

		<!-- SEO Meta Tags -->
		<Meta 
            title={title} 
            description={description} 
            heroImage={heroImage} 
            lang={lang}
            ogType={ogType}
            alternateLinks={finalAlternateLinks}
        >
			<slot name="schema" slot="schema" />
		</Meta>

		<!-- Fonts (Performance: Preconnect + Link instead of @import) -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

		<!-- If present, preloads the image passed as a prop -->
		{heroImage && <link rel="preload" href={heroImage.src} as="image" />}

		<!-- Sitewide Scripts -->
		<script src="@utils/nav.ts"></script>
	</head>
	<body>
		<!-- Screen reader skip main nav -->
		<a class="skip" aria-label="skip to main content" href="#main">Click To Skip To Main Content</a>

		<DynamicHeader lang={lang} />
		<main id="main">
			<slot />
		</main>
		<Footer lang={lang} />
	</body>
</html>
